# Vim

参考资料：

- [《Vim实用技巧》]()

# §2 实用技巧

## §2.1 `.`命令

`.`命令用于重复执行上一次的操作。从本质上来说，该命令是一种宏。所以对于高频次的重复操作，问题就转化为如何将这种操作设计成`.`命令可以重复的方式。

学完这一节后，我们就会知道：`.`只负责修改，还需要另一个命令进行移动。移动和修改交替进行，这种方法称为`.`范式。

### §2.1.1 空格格式化

给定以下任务，要求字符串之间的加号两侧带有空格：

```
"123"+"456"+"789"
"123" + "456" + "789"
```

操作步骤如下：

1. 将光标移动到行首，使用`f+`找到本行的第一个加号。
2. 使用`s`删除光标所在的字符，即第一个加号。
3. 输入`<空格>+<空格>`为第一个加号的两侧补充空格，按`<Esc>`退出。
4. 使用`;`表示向右查找后面的加号，再使用`.`命令重复第2、3步操作。
5. 重复第4步操作。

### §2.1.2 选择性替换

使用`%s/<原字符串>/<新字符串>/g`进行全局替换时，我们无法决定单个匹配项是否应该替换。

```
like appoint play
dislike disappoint play
```

下面介绍一种方法：

1. 将光标移动到要替换的单词内部。
2. 按下`*`，匹配到当前单词下一次出现的第一个字符。
3. 使用`cw`更改当前单词，输入`<新字符串>`完成单处替换。
4. 按下`n`，来延续`*`查找操作在寄存器中的内容，移动到下一次出现的第一个字符。
5. 重复步骤3、4，如果不想替换的话只重复步骤4。

## §2.2 复合命令

Vim将很多常用的两步操作合并成了一步，而这一步操作通常都是插入命令。

| 复合命令 | 复合命令的作用                 | 等效的长命令 | 等效的长命令作用                                   |
| -------- | ------------------------------ | ------------ | -------------------------------------------------- |
| `A`      | 在一行的结尾添加内容           | `$a`         | 将光标移动到最后一行，然后在光标的后面进入插入模式 |
| `s`      | 删除光标下的字符并进入编辑模式 | `cl`         | 更改光标右侧的字符                                 |
| `S`      |                                | `^c`         | ？？？？？？？                                     |
| `I`      |                                | `^i`         |                                                    |
| `A`      |                                | `$a`         |                                                    |
| `o`      |                                | `A<回车>`    |                                                    |
| `O`      |                                | `ko`         |                                                    |

## §2.3 重复与撤销

Vim为许多命令提过了对应的重复命令和撤销命令。

| 操作                       | 作用                           | 重复命令 | 撤销命令 |
| -------------------------- | ------------------------------ | -------- | -------- |
| 一次修改                   | `{编辑}`                       | `.`      | `u`      |
| 在行内搜索下一个字符位置   | `f{字符}`/`t{字符}`            | `;`      | `,`      |
| 在行内搜索上一个字符位置   | `F{字符}`/`T{字符}`            | `;`      | `,`      |
| 在文档中搜索下一处匹配位置 | `/<字符串><回车>`              | `n`      | `N`      |
| 在文档中搜索上一处匹配位置 | `?<字符串><回车>`              | `n`      | `N`      |
| 一次替换                   | `:s/<原字符串>/<替换后字符串>` | `n`      | `u`      |
| 多次修改                   | `qx{编辑}q`                    | `@x`     | `u`      |

### §2.3.1 撤销粒度

我们知道`u`命令用于撤销最近的一次修改。从按下`i`进入编辑模式开始，到按下`<ESC>`退出编辑模式位置，中间进行的所有修改记为一次修改。于是，我们可以通过控制每次编辑的内容，来控制撤销命令作用的范围，我们称之为撤销粒度。

> 注意：在插入模式中，使用箭头键会导致原先的撤销粒度被清空。为了便于理解，我们可以将其理解为先用`<ESC>`退出编辑模式，然后用``j`/`k`/`l``/`'`方位键进行移动，再按下`i`进入编辑模式。

### §2.3.2 构造可重复操作

给定以下文本，现在光标停留在单词`is`的最后一个字符。要求只保留两端的单词，删除中间的所有单词。

```
this is my favorite editor
this vim
```

下面我们要介绍三种操作，它们的操作步数均为3，但是可重复性有所不同。

1. 反向删除
   1. 使用`db`命令，删除从光标左侧开始，到单词开头的所有字符，此时字符`i`被删除，但是字符`s`没有被删除。
   2. 使用`x`命令，删除当前光标下的字符。
2. 正向删除
   1. 使用`b`命令，将光标移动到单词`is`的开头。
   2. 使用`dw`命令，删除从光标位置起、到光标位置所在的单词后的空格之间的所有字符（包括两端）。
3. 删除整个单词
   - 使用`daw`命令，删除光标所在的单词或空格之后的单词（包括空格）。

使用`.`命令重复上述操作时，第一种方法“反向删除”会删除当前光标下的字符，也就是空格；第二种方法“正向删除”会删除光标所在的单词，但是此时光标指向空格，所以删除的是空格；第三种该方法才能连续地删除单词。

### §2.3.3 指定重复次数

Vim的大多数命令支持在前面添加执行次数。例如`<Ctrl-x>`命令会尝试从光标开始向后搜寻最近的一个数字，并且将其减$1$。于是使用`100<Ctrl-a>`命令可以加$100$。

> 注意：如果数字字符串的开头有前导$0$，那么Vim会将其视为八进制数字，在字符串长度不变的前提下对其运算。如果需要让Vim默认所有数字均为十进制，可以编辑`.vimrc`文件。
>
> ```vimrc
> set nrformats=
> ```

要连续地删除两个单词，我们可以使用`d2w`命令或`2dw`命令。两者的作用完全相同，但是语义有所区别。`d2w`表示一次性删除两个单词；`2dw`命令表示重复两次删除一个单词的动作。同理，要连续地恢复两次操作，我们可以用`2.`命令；要一次性修改三个单词，我们可以使用`c3w`命令。

## §2.4 命令语法

Vim的操作由两部分构成：操作符与动作命令。以`daw`为例，`d`是操作符，表示删除，而后面的`aw`是动作命令，表示一个单词。

这种语法的优点在于其扩展能力强。例如我们已经知道`daw`用于删除一个单词，`gUap`表示将一个自然段中的所有字母全转为大写，那么很容易猜出来：`dap`表示删除一个自然段。

除此以外，Vim只有一个额外的语法：连续使用两次操作符，则动作命令默认指向当前行。例如`dd`表示删除当前行，`>>`表示缩进当前行。后来在此基础上，Vim语法对于以`g`开头进行转义的命令进行进一步简化。以`gU`为例，我们既可以使用`gUgU`，也可以使用`gUU`。

下表列出了Vim的所有操作符：

| 命令 | 用途                                   |
| ---- | -------------------------------------- |
| `c`  | 修改(change)                           |
| `d`  | 删除                                   |
| `y`  | 复制到寄存器                           |
| `g-` | 大小写反转                             |
| `gu` | 转换为小写                             |
| `gU` | 转换为大写                             |
| `>`  | 增加缩进                               |
| `<`  | 减小缩进                               |
| `=`  | 自动缩进                               |
| `!`  | 使用外部程序过滤`<动作命令>`所跨越的行 |

### §2.4.1 自定义操作符

Vim标准中的操作符数量较少，但是允许用户自定义新的操作符。以Tim Pope开发的[`commentary.vim`插件](https://github.com/tpope/vim-commentary)为例，它自定义了`\\`操作符用于切换注释。例如`\\ap`表示对当前自然段切换注释。

### §2.4.2 自定义动作命令

Vim标准中的动作命令已经很全面了，但是仍然允许用户自定义新的动作命令。以Kana Natsuno开发的[`textobj-entire`插件](https://github.com/kana/vim-textobj-entire)为例，它添加了两种针对整个文件的新文本对象——`ie`和`ae`。

在安装插件之前，如果要缩进整个文件，我们需要先用`gg`将光标移动到文件开头，然后再用`=G`表示对从光标到文件末尾的所有内容（即整个文档）执行自动缩进。而安装插件后，我们执行`=ae`命令即可。

## §2.5 插入模式

插入模式也有快捷键可用。这些快捷键以可以在`Bash`等Shell中使用。

| 插入模式快捷键             | 作用                                       |
| -------------------------- | ------------------------------------------ |
| `<Ctrl+h>`                 | 删除前一个字符（等价于退格键）             |
| `<Ctrl+w>`                 | 删除至前一个单词                           |
| `<Ctrl+u>`                 | 删除至行首                                 |
| `<Ctrl+[>`                 | 切换至普通模式（等价于`<Esc>`）            |
| `<Ctrl+o>`                 | 切换至普通模式，执行一个命令后返回插入模式 |
| `y`                        | 复制                                       |
| `<Ctrl+r>{寄存器}`         | 粘贴                                       |
| `<Ctrl+r><Ctrl+p>{寄存器}` | 粘贴                                       |
| `<Ctrl+v>{数字}`           | 插入Ascii字符或Unicode字符                 |

### §2.5.1 插入-普通模式

在插入模式下使用`<Ctrl+o>`，会进入插入-普通模式，具体行为是切换至普通模式，执行一个命令后返回插入模式。

例如使用`<Ctrl+o>zz`，让光标所在行位于Shell水平居中处。

### §2.5.2 复制与粘贴

给定以下文本，要求将开头的书名复制一份到该行末尾。

```
Practical Vim, is written by Drew Neil. I like
Practical Vim, is written by Drew Neil. I like Practical Vim
```

首先在编辑模式下将光标移动到行首，执行`yt,`，表示复制从光标开始到下一个`,`之间的内容到寄存器。然后执行`A`，将光标移动到行尾并进入编辑模式，自行插入一个`<空格>`，最后使用`<Ctrl+r>0`将寄存器0的内容粘贴到此处。

| 快捷键                     | 含义 | 特点                                                      |
| -------------------------- | ---- | --------------------------------------------------------- |
| `<Ctrl+r>{寄存器}`         | 粘贴 | 逐个字符粘贴，会受到`textwidth`或`autoindent`影响导致延迟 |
| `<Ctrl+r><Ctrl+p>{寄存器}` | 粘贴 | 整个字符串粘贴                                            |

### §2.5.3 表达式寄存器

在上一节中，我们直到`{寄存器}`表示寄存器的编号，通常是整数。Vim中存在一种特殊的寄存器，称为表达式寄存器，其编号为`=`。在编辑模式下使用`<Ctrl+r>=`可以访问这一寄存器，然后输入数学表达式（例如`1+1`），Vim就会将计算结果存入到表达式寄存器中，并且粘贴到当前位置。

### §2.5.4 以编码插入字符

Vim在编辑模式下支持`<Ctrl+v>{数字}`快捷键，用于输入Ascii或Unicode字符。数字有以下语法：

| `{数字}`语法                    | 含义        |
| ------------------------------- | ----------- |
| 三位十进制数字（`[0-9]{3}`）    | Ascii编码   |
| 四位十六进制数字（`u[0-9]{4}`） | Unicode编码 |

除此以外，如果`<Ctrl+v>`后面跟有非数字字符串，则表示原封不动地插入字符串。这个功能比较鸡肋。

在普通模式下使用`ga`命令，就能查看光标所在字符的编码信息。

### §2.5.5 二合字母

有些特殊字符（例如希腊字母、注音韵母、ASCII控制字符）无法直接输入，Vim提供了二合字母的机制，允许用两个字母映射到特殊字符。在编辑模式下使用`<Ctrl+k>{字母1}{字母2}`即可插入。具体的二合字母表可以通过`:digraphs`或`:h digraphs-default`查看。

### §2.5.6 替换模式/虚拟替换模式

在普通的编辑器中，我们知道`<Insert>`用于决定输入的字符是否会覆盖后一个字符。而在Vim中，在普通模式下使用`R`命令同样可以切换到替换模式。在替换模式下，`\t`制表符会被当成单独一个字符处理。

使用`gR`命令可以切换到虚拟替换模式，它会将制表符当成一堆空格处理。例如当`tabstop`为8时，输入前7个字符时一切正常，而输入第8个字符时才会替换制表符。

Vim也提供了针对单字符的替换模式`r`和虚拟替换模式`gr`。

## §2.6 可视模式

Vim的可视模式用于选中一块文本区域并对其操作。

`<Ctrl+g>`用于在可视模式和选择模式之间切换。两者的区别在于在选择模式下，可以直接键入任意字符串进入插入模式。

### §2.6.1 三种可视模式

可以细分为三种不同的可视模式，分别用于操作字符、操作行、操作块。

| 命令       | 作用               |
| ---------- | ------------------ |
| `v`        | 面向字符的可视模式 |
| `V`        | 面向行的可视模式   |
| `<Ctrl+v>` | 面向列块的可视模式 |
| `gv`       | 重选上次的高亮选区 |

高亮选取的范围由两个端点确定，其中一端固定，另一端随光标自由移动。通过命令`o`可以切换自由移动的端点。自由移动的光标可以以单词为单位移动，向前移动用`b`命令，向后移动用`e`命令。

例如给定下列Python，请修复其错误的两行代码缩进：

```python
def foo(n):
    for i in range(n):
print(i) # 这一行缩进错误
print(i * i) # 这一行缩进错误
```

要让Vim能执行缩进命令，我们首先要给Vim指定缩进长度：

```vimrc
# .vimrc配置文件
set shiftwidth=4 softtabstop=4 expandtab

# Vim终端临时配置
:set shiftwidth=4 softtabstop=4 expandtab
```

然后执行下列命令：

1. 将光标移动到出现缩进错误的第一行行首。
2. 执行`V`命令，进入面向行的可视模式，然后使用`j`同样选中下一行。
3. 使用`>`命令执行缩进，然后使用`.`命令重复执行缩进。这一步也可以用`2>`替代。

### §2.6.2 可视模式命令

可视模式和普通模式可以执行同一种操作，但是具体的命令可能不一样。例如要把单词转换为大写，我们在[§2.4 命令语法](##§2.4 命令语法)一节中学过`gU`命令。但是在可视模式中，我们选定目标单词后，需要用`U`命令。

这两种方法的可重复型不同。例如给定下列HTML文本，要求将标签中的内容转化为大写。在Vim中，`it`（Inside the Tag）是一个动作命令，表示XML标签内的内容。

```
<a href="#">abc</a>
<a href="#">abcde</a>
```

- 在可视模式中，我们可以用`vit`选中光标当前行的标签内内容，然后用`U`转换为大写。在Vim看来这是两个独立的命令，后一个命令等价于`gU3l`。所以执行`.j`想要对下一行进行同样操作时，Vim只会将前三个字符转换为大写。
- 在普通模式中，我们可以用操作符`gU`和动作命令`it`进行转换。在Vim看来这是一个完整的命令。所以执行`.j`想要对下一行进行同样操作时，Vim仍然会执行`gUit`命令，从而转换所有字母。

### §2.6.3 可视模式的插入

在VSCode中，我们可以方便地创建多个光标，并进行同步编辑。Vim也有这一功能，但是只有按下`<Esc>`从编辑模式退出到普通模式时，第一处光标的改动才能同步到其它光标，这的确是Vim的缺点之一。

例如给定下列文本，要求编辑路径文件夹为`folder2`：

```
./folder1/1.png
./folder1/2.png
./folder1/3.png
```

1. 将光标移动到第一行的路径文件夹`folder1`词首。
2. 使用`<Ctrl+v>`命令进入面向列块的可视模式，按下`jj`也选中下面的两行，按下`e`将光标移动到单词末尾。
3. 使用`c`命令删除三个光标所在的单词，并进入编辑模式。**删除单词是同步进行的**。
4. 输入改动后的路径文件夹。**输入改动是异步进行的**，此时只有第一行被改动，按下`<Esc>`退出到普通模式，其它行才会随之改动。

## §2.7 命令行模式

在按下`:`键、`/`键、`<Ctrl+r>`组合键时，Vim会切换到命令行模式，光标会移动到下方的操作缓冲区。执行的命令称为Ex命令，完整的命令列表和参考`:h ex-cmd-index`。下表列出了部分Ex命令。由于`:delete`、`:yank`、`:put`内容太多，所以后续详细介绍。

| 操作缓冲区的部分Ex命令                            | 作用                                                 |
| ------------------------------------------------- | ---------------------------------------------------- |
| `:[{range}]delete {寄存器}`                       | 删除指定范围的行（到寄存器中）                       |
| `:[{range}]yank {寄存器}`                         | 复制指定范围的行（到寄存器中）                       |
| `:[{line}]put {寄存器}`                           | 在指定行后粘贴寄存器中的内容                         |
| `:[{range}]copy {address}`                        | 把指定范围内的行复制到`{address}`指定的行下          |
| `:[{range}]move {address}`                        | 把指定范围内的行移动到`{address}`指定的行下          |
| `:[{range}]join`                                  | 连接指定范围内的行                                   |
| `:[{range}]normal {commands}`                     | 对指定范围的每一行执行普通模式下的命令               |
| `:[{range}]substitute/{pattern}/{string}/{flags}` | 把执行范围内出现`{pattern}`的匹配项替换为`{string}`  |
| `:[{range}]global/{pattern}/{cmd}`                | 对指定范围内匹配`{pattern}`的所有行执行Ex命令`{cmd}` |

### §2.7.1 `{range}`语法

以`:delete`（简写为`:d`）为例，我们可以用`:3d`表示输出第三行的内容。在普通模式实现同样的效果，需要`3Gdd`。

`[{range}]`是可选的。其语法为`{start},{end}`，其中的两个变量都是地址，这里既可以使用行号作为地址，也可以用`.`表示光标所在的行号，用`%`表示文件中的所有行，也可以用正则字符串来匹配（例如`:/<html>/,/<\/html>/`分别表示`<html>`标签的开始位置和闭合位置）。缺省时为当前行。

Vim还支持对`{start}`和`{end}`进行数学运算，以供手动提供偏移量。例如`::/<html>/+1,/<\/html>/-1`表示首尾各向内偏移一行。如果只有加减运算符，则默认与$1$做运算。

在选择模式下选中一部分区域，按下`:`时Vim会自动填充`:'<,'>`表示选定的区域。

综上所述，我们整理`{range}`的语法如下表所示：

| 符号        | 地址                       |
| ----------- | -------------------------- |
| `<数字>`    | 文件的第`<数字>`行         |
| `$`         | 文件的最后一行             |
| `0`         | 虚拟行，位于文件第一行上方 |
| `.`         | 光标所在行                 |
| `'<字符串>` | 包含位置标记`<字符串>`的行 |
| `'<`        | 可视模式高亮区域的起始行   |
| `'>`        | 可视模式高亮区域的结束行   |
| `%`         | 整个文件（等价于`:1,$`）   |

### §2.7.2 复制与移动

`:copy`（简写为`:co`、`:t`）用于复制，其语法为`:[{range}]copy {address}`，表示将`{range}`行的内容复制下来，并插入到`{address}`行后面。在普通模式下，我们需要用`yy`复制当前行，再用`p`粘贴到此处。

`:move`（简写为`:m`）用于移动，其语法为`:[{range}]move {address}`，表示将`{range}`行的内容剪切下来，并插入到`{address}`行后面。在普通模式下，我们需要用`d`删除高亮区域，再跳转至所需地方，最后用`p`粘贴到此处。